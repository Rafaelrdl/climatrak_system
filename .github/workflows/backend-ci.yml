# ============================================================================
# Backend CI Pipeline - ClimaTrak System
# ============================================================================
# Runs on every PR and push to main/develop branches
# Tests: Lint, Format check, Tests with Postgres, Migrations check, Tenant isolation

name: Backend CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'

env:
  PYTHON_VERSION: '3.12'
  DJANGO_SECRET_KEY: 'ci-secret-key-only-for-testing-not-for-production-use-minimum-50-chars'
  DJANGO_SETTINGS_MODULE: 'config.settings.development'
  DEBUG: 'True'
  DB_NAME: test_app
  DB_USER: postgres
  DB_PASSWORD: postgres
  DB_HOST: localhost
  DB_PORT: 5432
  REDIS_URL: redis://localhost:6379/0

jobs:
  # ==========================================================================
  # Job 1: Lint & Format Check
  # ==========================================================================
  lint:
    name: üîç Lint & Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install linting tools
        run: |
          pip install ruff black

      - name: Run Ruff (linter + import sorting)
        working-directory: backend
        run: |
          ruff check apps/ config/ --output-format=github

      - name: Check Black formatting
        working-directory: backend
        run: |
          black --check --diff apps/ config/

  # ==========================================================================
  # Job 2: Tests with PostgreSQL
  # ==========================================================================
  test:
    name: üß™ Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: timescale/timescaledb:latest-pg16-oss
        env:
          POSTGRES_DB: test_app
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django pytest-cov factory-boy

      - name: Wait for Postgres
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for postgres..."
            sleep 2
          done

      - name: Run migrations on public schema
        working-directory: backend
        run: |
          python manage.py migrate_schemas --shared

      - name: Run tests with coverage
        working-directory: backend
        run: |
          pytest apps/ -v --tb=short --cov=apps --cov-report=xml --cov-report=term-missing
        env:
          ALLOWED_HOSTS: localhost,testserver

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: backend/coverage.xml
          flags: backend
          fail_ci_if_error: false
        continue-on-error: true

  # ==========================================================================
  # Job 3: Migrations Check
  # ==========================================================================
  migrations-check:
    name: üì¶ Migrations Check
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: timescale/timescaledb:latest-pg16-oss
        env:
          POSTGRES_DB: test_app
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check for missing migrations
        working-directory: backend
        run: |
          python manage.py makemigrations --check --dry-run
        env:
          ALLOWED_HOSTS: localhost

      - name: Verify migrations can be applied
        working-directory: backend
        run: |
          python manage.py migrate_schemas --shared --plan
        env:
          ALLOWED_HOSTS: localhost

  # ==========================================================================
  # Job 4: Tenant Isolation Tests
  # ==========================================================================
  tenant-isolation:
    name: üîê Tenant Isolation
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: timescale/timescaledb:latest-pg16-oss
        env:
          POSTGRES_DB: test_app
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django factory-boy

      - name: Run migrations
        working-directory: backend
        run: |
          python manage.py migrate_schemas --shared
        env:
          ALLOWED_HOSTS: localhost

      - name: Run tenant isolation tests
        working-directory: backend
        run: |
          pytest apps/ -v -k "tenant" --tb=short || echo "No tenant-specific tests found yet"
        env:
          ALLOWED_HOSTS: localhost,testserver

  # ==========================================================================
  # Job 5: Security Check
  # ==========================================================================
  security:
    name: üõ°Ô∏è Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install bandit safety pip-audit

      - name: Run Bandit (security linter)
        working-directory: backend
        run: |
          bandit -r apps/ -ll -ii --skip B101
        continue-on-error: true

      - name: Check for vulnerable dependencies
        working-directory: backend
        run: |
          pip-audit -r requirements.txt --ignore-vuln GHSA-XXXX || true
        continue-on-error: true
